---
title: "Community analysis"
runtime: shiny
output: 
  html_document:
    toc: true
    toc_float: 
       collapsed: false
---

```{r setupcomman, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(shiny)
library(scales)
library(leaflet)
library(ggord)
library(vegan)

prj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

source('R/funcs.R')

data(habitat)
data(fishdat)
data(stream)

# prep species data, long format 
spdat <- fishdat %>% 
  select(Year, Watershed, SiteID, matches('^Sp_')) %>% 
  gather('species', 'pa', -Year, -SiteID, -Watershed, -geometry) %>% 
  mutate(
    species = gsub('^Sp_', '', species)
  ) %>% 
  filter(!is.na(Year))
```

<br>

## Overview maps

This map shows species presence/absence in the four watersheds.  Sites that were sampled in a given year are shown on the map with small red points indicating a species was not found and large green points indicating a species was found.

```{r sppinput}
# select a species
column(width = 6,
 selectInput('sp', 'Select a species:', sort(unique(spdat$species)), selected = 'Sthd')
)

# select a year
column(width = 6, 
       selectInput('yr', 'Select a year:', sort(unique(spdat$Year)))
       )
```

```{r prepmapsp}
# subset year and species,  map
mapspyr <- reactive({
  
  yr <- input$yr
  sp <- input$sp
  
  toplo <- spdat %>% 
    filter(Year == yr & species == sp) %>% 
    mutate(
      cexv = ifelse(pa == 1, 7, 3), 
      pa = factor(pa, levels = c('1', '0'), labels = c('present', 'absent')), 
      cols = ifelse(pa == 'present', 'lightgreen', 'tomato1')
      )
  
  # colors must be passed as vector
  cols <- toplo$cols
  
  out <- mapview(stream, label = stream$STREAM_NM, homebutton = F) +
    mapview(toplo, zcol = 'pa', cex = toplo$cexv, legend = F, homebutton = F, col.region = cols)
   
  return(out)
  
})
```

```{r mapsp}
renderLeaflet({mapspyr()@map})
```
<br>

## Percent occupied sites over time

Plot of percent of sampled sites over time with a selected species by watershed.  The total number of sites samples in a year is shown inside the point.

```{r tmsel}
# select a species
column(width = 6,
 selectInput('sptm', 'Select a species:', sort(unique(spdat$species)), selected = 'Sthd')
)

# year slider
column(width = 6, 
  sliderInput("yrs", label = 'Select year ranges to plot:',  
        min = 1994, max = 2017, 
        value = c(1994, 2017),
        sep = '', ticks = FALSE
      )
)
```

```{r spyragg}
# percent of sites where species was observed, by watershed, year
spyragg <- reactive({
  
  # inputs
  sp <- input$sptm
  yrs <- input$yrs
  
  # tabulate percent sites occupied
  out <- spdat
  st_geometry(out) <- NULL
  out <- out %>% 
    filter(species %in% sp) %>% 
    filter(Year >= yrs[1] & Year <= yrs[2]) %>% 
    group_by(Watershed, Year) %>% 
    summarize(
      nprs = sum(pa),
      nsites = n()
    ) %>% 
    mutate(
      prcsit = 100 * nprs / nsites
    )
  
  return(out)
  
})
```

```{r prsplo, fig.height = 6, fig.width = 8, out.width = "100%"}
renderPlot({
  
  # inputs
  toplo <- spyragg()
  sptm <- input$sptm
  
  p <- ggplot(toplo, aes(y = prcsit, x = Year)) + 
    geom_line() + 
    geom_point(pch = 21, aes(fill = prcsit), size = 8) +
    facet_wrap(~Watershed, ncol = 2) + 
    theme_bw(base_family = 'serif', base_size = 18) +
    theme(
      strip.background = element_blank(),
      axis.title.x = element_blank(), 
      legend.position = 'none'
    ) + 
    scale_y_continuous(paste0('% sites with ', sptm), limits = c(0, 100)) + 
    geom_text(aes(label = nsites), vjust = 0.5, size = 4, color = 'black') + 
    scale_fill_gradientn(colors = c('tomato1', 'lightgreen'), limits = c(0, 100))

  return(p)
                       
},width = 900, height = 600)

```
<br>

## Multivariate community analysis

Multivariate analysis of sites over time.

```{r mltsetup}
mltdat <- spdat
st_geometry(mltdat) <- NULL

# select a year
column(width = 6, 
       selectInput('yrmlt', 'Select a year:', sort(unique(mltdat$Year)), selected = 2017)
       )
```

```{r ord1}
# data for ordination first year
mltdatyr <- reactive({
  
  # inputs
  yrmlt <- input$yrmlt
  
  toord <- mltdat %>% 
    filter(Year == yrmlt) %>% 
    dplyr::select(SiteID, Watershed, species, pa) %>% 
    spread(species, pa)

  return(toord)
  
})

# wshed groups for ggord
wshdord1 <- reactive({
  
  mltdatyr() %>% pull(Watershed)
  
})

# ordination year 1
ord1 <- reactive({
  
  toord <- mltdatyr() %>% 
    select(-Watershed) %>% 
    column_to_rownames('SiteID')
  
  # metaMDS
  ord <- metaMDS(toord)
  
  return(ord)
  
})
```

```{r ord1plt, out.width = "100%"}
renderPlot({
  ggord(ord1(), grp_in = as.character(wshdord1()), vec_ext = 1, alpha = 0.8, size = 2, txt = 4, arrow = 0.2) + 
    theme_bw(base_family = 'serif', base_size= 20)
}, width = 850, height = 850)
```

