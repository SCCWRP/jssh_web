---
title: ""
output: 
  html_document
self_contained: true
runtime: shiny
---
<br>

## Salmonid status and trends

```{r, message = F, warning = F, results = 'hide', echo = F}
# globals
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T, echo = F, fig.path = 'imgs/')

library(tidyverse)
library(sf)
library(mapview)
library(plotly)
library(shiny)
library(leaflet)

data(habitat)
data(fishdat)
data(stream)
```

This map shows the stream network and sample sites by watershed.  Click on a stream reach or sample site for additional information.
```{r mapview1, out.width="100%"}
mapview(stream, label = stream$STREAM_NM) +
  mapview(fishdat, zcol = 'Watershed', legend = T)
```

<br>

Select a year and size class to view on the map:

```{r mapview2}

selectInput("cls", "Choose density (S1: yoy, S2: adult):", c('Dens_S1', 'Dens_S2'))

selectInput("yr", "Choose a year to plot:", fishdat$Year %>% unique %>% na.omit)

mapout <- reactive({
  
  toplo <- fishdat %>% 
    filter(Year %in% input$yr)
  
  out <- mapview(stream, label = stream$STREAM_NM) +
    mapview(toplo, zcol = 'Watershed', cex = input$cls, legend = T)
   
  return(out)
  
})

renderLeaflet({mapout()@map})

```

<br>

Salmonid density (fish/100ft) at each site is measured as S1 and S2 for different size classes, where S1 is considered young-of-the-year (< 75mm standard length) and S2 is larger individuals that are likely to migrate the following spring. The boxplots show the distribution of the density estimates across all sites for a given year, by watershed. 
```{r boxdens, fig.height = 7}
toplo <- fishdat
st_geometry(toplo) <- NULL
toplo <- toplo%>% 
  dplyr::select(Year, SiteID, Watershed, Dens_S1, Dens_S2) %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(Year = factor(Year)) %>% 
  filter(!is.na(Year))

p <- ggplot(toplo, aes(x = Year, y = density, fill = `Size class`)) + 
  geom_boxplot() + 
  facet_wrap(~Watershed, ncol = 1) + 
  scale_y_continuous('Density (fish/100ft)', trans = 'log10') + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    strip.background = element_blank(), 
    axis.title.x = element_blank(), 
    legend.position = 'top'
  )
p
```

<br>

Are densities changing by watershed? This plot shows changes from the long-term average by watershed and density.  Differences are based on the average across all years in a watershed and density class, log-scale.

```{r tiledens, fig.height = 5, fig.width = 8}
# remove 1981 all watersheds
# remove 1994 from PAJ and SAQ
toeval <- fishdat %>% 
  filter(Year > 1981) %>% 
  filter(!(Year == 1994 & Watershed %in% c('PAJ', 'SOQ')))

# get averages across stations
st_geometry(toeval) <- NULL
toeval <- toeval %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(density = log10(1 + density)) %>% 
  group_by(Watershed, `Size class`, Year) %>% 
  summarise(
    density = mean(density, na.rm = T)
    ) %>% 
  group_by(Watershed, `Size class`) %>% 
  mutate(
    density_df = density - mean(density, na.rm = T)
  )

pbase <- theme_bw(base_family = 'serif') +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8), 
    axis.text.y = element_text(size = 8),
    legend.position = 'top',
    legend.direction = 'horizontal',
    # plot.margin = unit(c(4,4,0,0), "lines"),
    strip.background = element_blank(), 
    strip.text.y = element_text(angle = 0, hjust = 0, vjust = 0.5), 
    panel.background = element_rect(fill = 'black')
  ) 

ggplot(toeval) + 
  geom_tile(aes(x = Year, y = Watershed, fill = density_df), colour = 'black') + 
  pbase +
  scale_x_continuous('', expand = c(0, 0)) + 
  scale_y_discrete('', expand = c(0, 0)) +
  scale_fill_gradient2('Difference from average,\nby watershed, density', low = 'tomato1', mid = "white", high = 'lightgreen', midpoint = 0) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 5, label.theme = element_text(size = 6, angle = 0))) +
  facet_wrap(~ `Size class`, ncol = 1)
```



