---
title: ""
runtime: shiny
---

<br></br>

## Salmonid status and trends

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(plotly)
library(shiny)
library(scales)
library(leaflet)
library(stargazer)
library(EnvStats)
library(kableExtra)

source('R/funcs.R')

data(habitat)
data(fishdat)
data(stream)
```

This map shows the stream network and sample sites by watershed.  Click on a stream reach or sample site for additional information.
```{r mapviewshed, out.width="100%"}
mapview(stream, label = stream$STREAM_NM) +
  mapview(fishdat, zcol = 'Watershed', legend = T)
```

<br></br>

Select a year and size class to view on the map:

```{r mapviewsel}

selectInput("cls", "Choose density (S1: yoy, S2: adult):", c('Dens_S1', 'Dens_S2'))

selectInput("yr", "Choose a year to plot:", fishdat$Year %>% unique %>% na.omit)
```
```{r}

mapout <- reactive({
  
  toplo <- fishdat %>% 
    filter(Year %in% input$yr)
  
  out <- mapview(stream, label = stream$STREAM_NM) +
    mapview(toplo, zcol = 'Watershed', cex = input$cls, legend = T)
   
  return(out)
  
})
```
```{r}
renderLeaflet({mapout()@map})
```

<br></br>

Salmonid density (fish/100ft) at each site is measured as S1 and S2 for different size classes, where S1 is considered young-of-the-year (< 75mm standard length) and S2 is larger individuals that are likely to migrate the following spring. The boxplots show the distribution of the density estimates across all sites for a given year, by watershed. 

```{r densbox, fig.height = 6, fig.width = 6, out.width = "80%", fig.align="center"}
toplo <- fishdat
st_geometry(toplo) <- NULL
toplo <- toplo%>% 
  dplyr::select(Year, SiteID, Watershed, Dens_S1, Dens_S2) %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(Year = factor(Year)) %>% 
  filter(!is.na(Year))

p <- ggplot(toplo, aes(x = Year, y = density, fill = `Size class`)) + 
  geom_boxplot() + 
  facet_wrap(~Watershed, ncol = 1) + 
  scale_y_continuous('Density (fish/100ft)', trans = 'log10') + 
  theme_bw(base_family = 'serif') + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    strip.background = element_blank(), 
    axis.title.x = element_blank(), 
    legend.position = 'top'
  )

p
```

<br></br>

Are densities changing by watershed? This plot shows changes from the long-term average by watershed and density.  The colors show the differences of each year from the long-term average across all years and sites for each watershed and density class, log-scale.

```{r denstile, fig.height = 4, fig.width = 7, out.width = "100%"}
# remove 1981 all watersheds
# remove 1994 from PAJ and SAQ
toeval <- fishdat %>% 
  filter(Year > 1981) %>% 
  filter(!(Year == 1994 & Watershed %in% c('PAJ', 'SOQ')))

# get averages across stations
st_geometry(toeval) <- NULL
toplo <- toeval %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(density = log10(1 + density)) %>% 
  group_by(Watershed, `Size class`, Year) %>% 
  summarise(
    density = mean(density, na.rm = T)
    ) %>% 
  group_by(Watershed, `Size class`) %>% 
  mutate(
    density_df = density - mean(density, na.rm = T)
  )

pbase <- theme_bw(base_family = 'serif') +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8), 
    axis.text.y = element_text(size = 8),
    legend.position = 'top',
    legend.direction = 'horizontal',
    # plot.margin = unit(c(4,4,0,0), "lines"),
    strip.background = element_blank(), 
    strip.text.y = element_text(angle = 0, hjust = 0, vjust = 0.5), 
    panel.background = element_rect(fill = 'black')
  ) 

p <- ggplot(toplo) + 
  geom_tile(aes(x = Year, y = Watershed, fill = density_df), colour = 'black') + 
  pbase +
  scale_x_continuous('', expand = c(0, 0)) + 
  scale_y_discrete('', expand = c(0, 0)) +
  scale_fill_gradient2('Difference from average,\nby watershed, density', low = 'tomato1', mid = "white", high = 'lightgreen', midpoint = 0) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 5, label.theme = element_text(size = 6, angle = 0))) +
  facet_wrap(~ `Size class`, ncol = 1)

p
```

<br></br>

These plots show a more formal evaluation of the trends as measured by the significance of the regression through the trend anomalies. All sites in a watershed are grouped. 

```{r trendevalrct}

##
# reactive inputs for plots, tables 

# year slider
sliderInput("years", label = 'Select year ranges to test:',  
      min = 1994, max = 2017, 
      value = c(1994, 2017),
      sep = '', ticks = FALSE
    )

# plot data from year input, s1
toplos1 <- reactive({
  
  toplos1 <- toplo %>% 
    filter(`Size class` %in% 'Dens_S1') %>% 
    filter(Year >= input$years[1] & Year <= input$years[2])
  
  return(toplos1)
  
})

# plot data from year input, s2
toplos2 <- reactive({
  
  toplos2 <- toplo %>% 
    filter(`Size class` %in% 'Dens_S2') %>% 
    filter(Year >= input$years[1] & Year <= input$years[2])
  
  return(toplos2)
  
})

# table data from plot input, s1
totabs1 <- reactive({
  
  totabs1 <- toplos1() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        lmout <- lm(density_df ~ Year, x) 
        return(lmout)
        
      })
  
    ) %>% 
    select(-data)
  
  return(totabs1)
  
})

# table data kendall test from plot 1, s1
totabs1kn <- reactive({
  
  totabs1kn <- toplos1() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        knout <- kendallTrendTest(density_df ~ Year, x)
        outest <- round(knout$estimate, 2)
        outpval <- p_ast(knout$p.value)
        out <- c(outest, pval = outpval) %>% 
          data.frame %>% 
          t %>% 
          data.frame %>% 
          select(-intercept)
        return(out)
        
      })
  
    ) %>% 
    select(-data) %>% 
    unnest
  
  return(totabs1kn)
  
})

# table data from plot input, s2
totabs2 <- reactive({
  
  totabs2 <- toplos2() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        lmout <- lm(density_df ~ Year, x) 
        return(lmout)
        
      })
  
    ) %>% 
    select(-data)
  
  return(totabs2)
  
})

# table data kendall test from plot 1, s2
totabs2kn <- reactive({
  
  totabs2kn <- toplos2() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        knout <- kendallTrendTest(density_df ~ Year, x)
        outest <- round(knout$estimate, 2)
        outpval <- p_ast(knout$p.value)
        out <- c(outest, pval = outpval) %>% 
          data.frame %>% 
          t %>% 
          data.frame %>% 
          select(-intercept)
        return(out)
        
      })
  
    ) %>% 
    select(-data) %>% 
    unnest
  
  return(totabs2kn)
  
})

```

## {.tabset}

### S1 year class

```{r s1trnd, fig.height = 4, fig.width = 8, out.width = "100%"}
renderPlot({
  
  p <- ggplot(toplos1(), aes(x = Year, y = density_df, fill = density_df)) + 
    geom_bar(stat = 'identity', colour = 'grey') + 
    scale_fill_gradient2('', low = 'tomato1', mid = 'white', high = 'lightgreen', midpoint = 0) +
    facet_wrap(~ Watershed) + 
    geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) + 
    scale_y_continuous('Density (fish/100ft)') +
    geom_hline(yintercept = 0) + 
    ggtitle('S1 size class')
  
  return(p)
  
})
```

<br></br>

Summary of regression results for each watershed: 

```{r, results = 'asis'}
renderUI({
  HTML(stargazer(totabs1()$res, type = 'html', column.labels = as.character(totabs1()$Watershed),
            dep.var.labels = 'Density (fish/100ft)'))
  })
```

<br></br>

Results from Kendall tests evaluating magnitude, direction, and significance of the trend between the selected years. 

```{r, results = 'asis'}
renderUI({
  HTML(knitr::kable(totabs1kn(), format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
  })
```

### S2 year class

```{r s2trnd, fig.height = 4, fig.width = 8, out.width = "100%"}
renderPlot({
  
  p <- ggplot(toplos2(), aes(x = Year, y = density_df, fill = density_df)) + 
    geom_bar(stat = 'identity', colour = 'grey') + 
    scale_fill_gradient2('', low = 'tomato1', mid = 'white', high = 'lightgreen', midpoint = 0) +
    facet_wrap(~ Watershed) + 
    geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) + 
    scale_y_continuous('Density (fish/100ft)') +
    geom_hline(yintercept = 0) + 
    ggtitle('S2 size class')
  
  return(p)
  
})
```

<br></br>

Summary of regression results for each watershed: 

```{r, results = 'asis'}
renderUI({
  HTML(stargazer(totabs2()$res, type = 'html', column.labels = as.character(totabs2()$Watershed),
            dep.var.labels = 'Density (fish/100ft)'))
  })
```

<br></br>

Results from Kendall tests evaluating magnitude, direction, and significance of the trend between the selected years. 

```{r, results = 'asis'}
renderUI({
  HTML(knitr::kable(totabs2kn(), format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
  })
```

```{r test}
plot(rnorm(100))
```
