---
title: "Salmonid status and trends"
runtime: shiny
output: 
  html_document:
    toc: true
    toc_float: 
       collapsed: false
---

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(plotly)
library(shiny)
library(scales)
library(leaflet)
library(stargazer)
library(EnvStats)
library(kableExtra)

prj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

source('R/funcs.R')

data(fishdat)
data(stream)
data(trndst_prep)
```

The objective of these analyses are to evaluate the status and trends of Steelhead salmon in the four watersheds:

* APT: Aptos
* PAJ: Pajaro
* SLR: San Lorenzo
* SOQ: Soquel

Maps and summary plots show the changes in density (fish/100ft) over time of the differente size classes (`Dens_S1` or `Dens_S2`). Salmonid density (fish/100ft) at each site is measured as S1 and S2, where S1 is considered young-of-the-year (< 75mm standard length) and S2 is larger individuals that are likely to migrate the following spring. Trend statistics of the different size classes for aggregated watershed data and by site are also provided.  The trend analyses only evaluate a monotonic change between selected years.

## Overview maps

This map shows the stream network and sample sites by watershed.  Click on a stream reach or sample site for additional information.  All sites with data collected during any of the sample years are shown. 

```{r mapviewshed, out.width="100%"}
mapview(stream, label = stream$STREAM_NM) +
  mapview(fishdat, zcol = 'Watershed', legend = T)
```

<br></br>

This map shows the density of S1 or S2 individuals for a chosen year where data are availabl.  Select a year and size class to view on the map.  The size of the point shows the relative density at a sampled site. 

```{r mapviewsel}

selectInput("cls", "Choose density (S1: yoy, S2: adult):", c('Dens_S1', 'Dens_S2'))

selectInput("yr", "Choose a year to plot:", fishdat$Year %>% unique %>% na.omit)
```
```{r}

mapout <- reactive({
  
  toplo <- fishdat %>% 
    filter(Year %in% input$yr)
  
  out <- mapview(stream, label = stream$STREAM_NM) +
    mapview(toplo, zcol = 'Watershed', cex = input$cls, legend = T)
  
  return(out)
  
})
```
```{r}
renderLeaflet({mapout()@map})
```

<br></br>

## Overview plots

The boxplots show the distribution of the density estimates across all sites for a given year, by watershed. 

```{r densbox, fig.height = 6, fig.width = 6, out.width = "80%", fig.align="center"}
toplo <- fishdat
st_geometry(toplo) <- NULL
toplo <- toplo%>% 
  dplyr::select(Year, SiteID, Watershed, Dens_S1, Dens_S2) %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(Year = factor(Year)) %>% 
  filter(!is.na(Year))

p <- ggplot(toplo, aes(x = Year, y = density, fill = `Size class`)) + 
  geom_boxplot() + 
  facet_wrap(~Watershed, ncol = 1) + 
  scale_y_continuous('Density (fish/100ft)', trans = 'log10') + 
  theme_bw(base_family = 'serif') + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    strip.background = element_blank(), 
    axis.title.x = element_blank(), 
    legend.position = 'top'
  )

p
```

<br></br>

This plot shows the changes from the long-term average by watershed and size class.  The colors show the differences of each year from the long-term average (trend anomaly) across all years and sites for each watershed and density class, log-scale.  It can be used to evaluate an approximate change over time relative to the long-term average.

```{r denstile, fig.height = 4, fig.width = 7, out.width = "100%"}
# remove 1981 all watersheds
# remove 1994 from PAJ and SAQ
toeval <- fishdat %>% 
  filter(Year > 1981) %>% 
  filter(!(Year == 1994 & Watershed %in% c('PAJ', 'SOQ')))

# get averages across stations
st_geometry(toeval) <- NULL
toplo <- toeval %>% 
  gather('Size class', 'density', Dens_S1, Dens_S2) %>% 
  mutate(density = log10(1 + density)) %>% 
  group_by(Watershed, `Size class`, Year) %>% 
  summarise(
    density = mean(density, na.rm = T)
    ) %>% 
  group_by(Watershed, `Size class`) %>% 
  mutate(
    density_df = density - mean(density, na.rm = T)
  )

pbase <- theme_bw(base_family = 'serif') +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8), 
    axis.text.y = element_text(size = 8),
    legend.position = 'top',
    legend.direction = 'horizontal',
    # plot.margin = unit(c(4,4,0,0), "lines"),
    strip.background = element_blank(), 
    strip.text.y = element_text(angle = 0, hjust = 0, vjust = 0.5), 
    panel.background = element_rect(fill = 'black')
  ) 

p <- ggplot(toplo) + 
  geom_tile(aes(x = Year, y = Watershed, fill = density_df), colour = 'black') + 
  pbase +
  scale_x_continuous('', expand = c(0, 0)) + 
  scale_y_discrete('', expand = c(0, 0)) +
  scale_fill_gradient2('Difference from average,\nby watershed, density', low = 'tomato1', mid = "white", high = 'lightgreen', midpoint = 0) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 5, label.theme = element_text(size = 6, angle = 0))) +
  facet_wrap(~ `Size class`, ncol = 1)

p
```

<br></br>

## Trend statistics, by watershed {.tabset}

These plots provide a formal evaluation of the trends as measured by the significance of the regression through the trend anomalies. All sites in a watershed are grouped. The slider can be used to adjust the range of years that are evaluated, e.g., a trend may be observed for one range but not another.

```{r trendevalrct}

##
# reactive inputs for plots, tables 

# year slider
sliderInput("years", label = 'Select year ranges to test:',  
      min = 1994, max = 2017, 
      value = c(1994, 2017),
      sep = '', ticks = FALSE
    )

# plot data from year input, s1
toplos1 <- reactive({
  
  toplos1 <- toplo %>% 
    filter(`Size class` %in% 'Dens_S1') %>% 
    filter(Year >= input$years[1] & Year <= input$years[2])
  
  return(toplos1)
  
})

# plot data from year input, s2
toplos2 <- reactive({
  
  toplos2 <- toplo %>% 
    filter(`Size class` %in% 'Dens_S2') %>% 
    filter(Year >= input$years[1] & Year <= input$years[2])
  
  return(toplos2)
  
})

# table data from plot input, s1
totabs1 <- reactive({
  
  totabs1 <- toplos1() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        lmout <- lm(density_df ~ Year, x) 
        return(lmout)
        
      })
  
    ) %>% 
    select(-data)
  
  return(totabs1)
  
})

# table data kendall test from plot 1, s1
totabs1kn <- reactive({
  
  totabs1kn <- toplos1() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        knout <- kendallTrendTest(density_df ~ Year, x)
        outest <- round(knout$estimate, 2)
        outpval <- p_ast(knout$p.value)
        out <- c(outest, pval = outpval) %>% 
          data.frame %>% 
          t %>% 
          data.frame %>% 
          select(-intercept)
        return(out)
        
      })
  
    ) %>% 
    select(-data) %>% 
    unnest
  
  return(totabs1kn)
  
})

# table data from plot input, s2
totabs2 <- reactive({
  
  totabs2 <- toplos2() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        lmout <- lm(density_df ~ Year, x) 
        return(lmout)
        
      })
  
    ) %>% 
    select(-data)
  
  return(totabs2)
  
})

# table data kendall test from plot 1, s2
totabs2kn <- reactive({
  
  totabs2kn <- toplos2() %>% 
    group_by(Watershed) %>% 
    nest %>% 
    mutate(
      res = purrr::map(data, function(x){
        
        knout <- kendallTrendTest(density_df ~ Year, x)
        outest <- round(knout$estimate, 2)
        outpval <- p_ast(knout$p.value)
        out <- c(outest, pval = outpval) %>% 
          data.frame %>% 
          t %>% 
          data.frame %>% 
          select(-intercept)
        return(out)
        
      })
  
    ) %>% 
    select(-data) %>% 
    unnest
  
  return(totabs2kn)
  
})

```

### S1 year class

```{r s1trnd, fig.height = 4, fig.width = 8, out.width = "100%"}
renderPlot({
  
  p <- ggplot(toplos1(), aes(x = Year, y = density_df, fill = density_df)) + 
    geom_bar(stat = 'identity', colour = 'grey') + 
    scale_fill_gradient2('', low = 'tomato1', mid = 'white', high = 'lightgreen', midpoint = 0) +
    facet_wrap(~ Watershed) + 
    geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) + 
    scale_y_continuous('Density (fish/100ft)') +
    geom_hline(yintercept = 0) + 
    ggtitle('S1 size class')
  
  return(p)
  
})
```

<br></br>

This table shows the regression results from the above plots. 

```{r, results = 'asis'}
renderUI({
  HTML(stargazer(totabs1()$res, type = 'html', column.labels = as.character(totabs1()$Watershed),
            dep.var.labels = 'Density (fish/100ft)'))
  })
```

<br></br>

Kendall tests also provide an indication of a trend by by evaluating magnitude, direction, and significance of a change in density between the selected years.  The test is a non-parametric equivalent to the regression analysis above.  The value for tau ranges from -1 to 1 and provides a measure of trend direcdtion.  The slope is the estimated change per year in density and the p-value shows the significance of the test. 

```{r, results = 'asis'}
renderUI({
  HTML(knitr::kable(totabs1kn(), format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
  })
```

### S2 year class

```{r s2trnd, fig.height = 4, fig.width = 8, out.width = "100%"}
renderPlot({
  
  p <- ggplot(toplos2(), aes(x = Year, y = density_df, fill = density_df)) + 
    geom_bar(stat = 'identity', colour = 'grey') + 
    scale_fill_gradient2('', low = 'tomato1', mid = 'white', high = 'lightgreen', midpoint = 0) +
    facet_wrap(~ Watershed) + 
    geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) + 
    scale_y_continuous('Density (fish/100ft)') +
    geom_hline(yintercept = 0) + 
    ggtitle('S2 size class')
  
  return(p)
  
})
```

<br></br>

This table shows the regression results from the above plots. 

```{r, results = 'asis'}
renderUI({
  HTML(stargazer(totabs2()$res, type = 'html', column.labels = as.character(totabs2()$Watershed),
            dep.var.labels = 'Density (fish/100ft)'))
  })
```

<br></br>

Kendall tests also provide an indication of a trend by by evaluating magnitude, direction, and significance of a change in density between the selected years.  The test is a non-parametric equivalent to the regression analysis above.  The value for tau ranges from -1 to 1 and provides a measure of trend direcdtion.  The slope is the estimated change per year in density and the p-value shows the significance of the test. 

```{r, results = 'asis'}
renderUI({
  HTML(knitr::kable(totabs2kn(), format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
  })
```

## Trend statistics, by site

This section evaluates status and trends of salmonid density at individual sites, rather than aggregated by watershed as above.  Select the year range and size density class to evaluate the trends.  The map shows the value for tau (direction of trend) for a Kendall test of density changes within the selected years, green for increasing and red for decreasing.  Size of the point is the magnitude of the estimated change. Note that some site may not have data spanning the full range of selected years.  Click an individual site on the mape to see the years within the selected range. 

```{r sitetrndmapprp}
##
# reactive inputs for plots, tables 

selectInput("clsst", "Choose density (S1: yoy, S2: adult):", c('Dens_S1', 'Dens_S2'))

# year slider
sliderInput("yearsst", label = 'Select year ranges to test:',  
      min = 1994, max = 2017, 
      value = c(1994, 2017),
      sep = '', ticks = FALSE
    )

# filter site data by density class, years
# get kendall results where appropriate
mapdatst <- reactive({
  
  toplo <- trndst_prep %>% 
    filter(`Size class` %in% input$clsst) %>% 
    mutate(trnd = purrr::map(data, function(x){
      
      xsub <- x %>% 
        filter(Year >= input$yearsst[1] & Year <= input$yearsst[2]) %>%
        mutate(
          avedens = mean(density, na.rm = T), 
          density = density - avedens
          ) %>% 
        dplyr::select(-avedens)
      
      # get unique years tested
      yrs <- unique(xsub$Year) %>% 
        paste(collapse = ', ')

      # kendall sum
      knout <- suppressWarnings(try({kendallTrendTest(density ~ Year, xsub)}, silent = T))
      if(inherits(knout, 'try-error')) return(NA)
      kpval <- knout$p.value
      kest <- knout$estimate
      out <- c(kpval, kest) %>% 
        as.list %>% 
        data.frame %>% 
        mutate(yrs = yrs)
         
      return(out)

      })
    ) %>% 
    dplyr::select(-data) %>% 
    filter(map_lgl(trnd, ~ !anyNA(.x))) %>% # this!
    unnest %>% 
    dplyr::select(-intercept) %>% 
    mutate(
      z = p_ast(z), 
      trend = sign(tau),
      trend = factor(trend, levels = c(-1, 1), labels =c('dec', 'inc'))
      ) %>% 
    mutate_if(is.numeric, round, 2) %>% 
    rename(pval = z) %>% 
    st_as_sf(coords = c("X", "Y"), crs =prj)
  
  return(toplo)
  
  })

# create map from selected, trended data
mapoutst <- reactive({

  cols <- mapdatst() %>% 
    mutate(
      cols = factor(trend, levels = c('dec', 'inc'), labels = c('tomato1', 'lightgreen')),
      cols = as.character(cols)
    ) %>% 
    pull(cols)

  out <- mapview(stream, label = stream$STREAM_NM, homebutton = F) +
    mapview(mapdatst(), zcol = 'trend', cex = "tau", label = paste(mapdatst()$SiteID, ': ', mapdatst()$trend), col.regions = cols, legend = F, homebutton = F)
  
  return(out)
  
  
  })
```
```{r sitetrndmap}
# render the site trend map  
renderLeaflet({mapoutst()@map})
```

A regression through the trend anomalies for the size class densities at a selected site is shown below.  These plots can confirm the results shown in the map. 

```{r sitetrndpltprp}

# dynamic ui that changes with year selections on map, differents sites depending on year combos
renderUI({

  sts <- mapdatst()$SiteID %>% unique %>% sort
  selectInput("st", "Select station to view map trends:", sts)

})

# filter site data by years, individual site
trndatst <- reactive({
  
  yrsel <- input$yearsst
  stsel <- input$st
  
  req(!is.null(stsel))
  
  toplo <- trndst_prep %>% 
    filter(SiteID %in% stsel) %>% 
    unnest %>% 
    filter(Year >= yrsel[1] & Year <= yrsel[2]) %>% 
    group_by(`Size class`) %>% 
    mutate(
      avedens = mean(density, na.rm = T), 
      density_df = density - avedens
      ) %>% 
    dplyr::select(-avedens)
  
  return(toplo)

  })
```

```{r sitetrndplt, fig.height = 4, fig.width = 8, out.width = "100%"}
# plot of year trends at a site
renderPlot({
  
  toplo <- trndatst()
  stsel <- input$st

  req(!is.null(stsel))
  
  p <- ggplot(toplo, aes(x = Year, y = density_df, fill = density_df)) + 
    geom_bar(stat = 'identity', colour = 'grey') + 
    scale_fill_gradient2('', low = 'tomato1', mid = 'white', high = 'lightgreen', midpoint = 0) +
    facet_wrap(~ `Size class`, ncol = 2) + 
    geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) + 
    scale_y_continuous('Density (fish/100ft)') +
    geom_hline(yintercept = 0) + 
    ggtitle(paste0('Trends at ', stsel))
  
  return(p)
  
})

```

```{r test}
plot(rnorm(100))
```
